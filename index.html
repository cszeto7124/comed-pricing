<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ComEd 5-Minute Electricity Price</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2em; background: #f4f4f4; color: #333; }
    h1 { font-size: 1.5em; }
    .highlight { color: darkgreen; font-size: 1.5em; }
    #price, #forecast, #stats { margin-top: 1em; font-size: 1.2em; }
    button { margin-top: 1em; }
    canvas { margin-top: 2em; }
  </style>
</head>
<body>
  <h1>Live ComEd 5-Minute Electricity Price</h1>
  <div id="price">Loading...</div>
  <div id="forecast"></div>
  <div id="stats"></div>
  <button onclick="requestNotificationPermission()">Enable Price Alerts</button>
  <canvas id="priceChart" width="800" height="300"></canvas>

  <script>
    let alertedAlready = false;
    let chart;

    function requestNotificationPermission() {
      if (!('Notification' in window)) return;
      if (Notification.permission === 'granted') {
        alert('Notifications already enabled!');
      } else {
        Notification.requestPermission().then(p => {
          if (p === 'granted') alert('✅ Notifications enabled.');
          else alert('❌ Notifications denied.');
        });
      }
    }

    function sendNotification(price, time) {
      if (Notification.permission === 'granted') {
        new Notification('⚠️ High Price Alert', {
          body: `Price is ${price}¢/kWh at ${time}`,
          icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/fb/Lightbulb_icon.svg/512px-Lightbulb_icon.svg.png'
        });
      }
    }

    async function fetchPrice() {
      const now = Date.now();
      const tenMinLater = now + 10 * 60 * 1000;
      const proxy = 'https://api.allorigins.win/get?url=';
      const base = 'https://hourlypricing.comed.com/api?type=5minutefeed';
      const url = proxy + encodeURIComponent(base + `&t=${now}`);

      try {
        const res = await fetch(url);
        const wrapper = await res.json();
        const data = JSON.parse(wrapper.contents);
        data.sort((a, b) => a.millisUTC - b.millisUTC);

        const history = data.filter(d => Number(d.millisUTC) <= now);
        const future = data.find(d => Number(d.millisUTC) > now && Number(d.millisUTC) <= tenMinLater);

        const current = [...data].reverse().find(d => Number(d.millisUTC) <= now);
        const price = parseFloat(current.price).toFixed(1);
        const time = new Date(Number(current.millisUTC)).toLocaleString();

        document.getElementById('price').innerHTML =
          `<span class="highlight">${price}¢/kWh</span> at ${time}`;

        if (parseFloat(price) > 20 && !alertedAlready) {
          sendNotification(price, time);
          alertedAlready = true;
        } else if (parseFloat(price) <= 20) {
          alertedAlready = false;
        }

        if (future) {
          const fPrice = parseFloat(future.price).toFixed(1);
          const fTime = new Date(Number(future.millisUTC)).toLocaleTimeString();
          document.getElementById('forecast').innerHTML =
            `<strong>Next Forecast:</strong> ${fPrice}¢ at ${fTime}`;
        } else {
          document.getElementById('forecast').innerHTML = '';
        }

        let high = { price: -Infinity, time: null };
        let low = { price: Infinity, time: null };
        let total = 0;

        history.forEach(entry => {
          const p = parseFloat(entry.price);
          total += p;
          const t = new Date(Number(entry.millisUTC)).toLocaleTimeString();
          if (p > high.price) high = { price: p, time: t };
          if (p < low.price) low = { price: p, time: t };
        });

        const avg = (total / history.length).toFixed(1);
        document.getElementById('stats').innerHTML = `
          <p><strong>High:</strong> ${high.price}¢ at ${high.time}</p>
          <p><strong>Low:</strong> ${low.price}¢ at ${low.time}</p>
          <p><strong>Average:</strong> ${avg}¢</p>
        `;

        renderChart(history);
      } catch (e) {
        console.error(e);
        document.getElementById('price').innerText = 'Error loading data.';
      }
    }

    function renderChart(history) {
      const labels = history.map(d => new Date(Number(d.millisUTC)).toLocaleTimeString());
      const prices = history.map(d => parseFloat(d.price));

      const ctx = document.getElementById('priceChart').getContext('2d');

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Actual Price (¢/kWh)',
            data: prices,
            borderColor: 'green',
            tension: 0.3,
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 12 } },
            y: { beginAtZero: true }
          }
        }
      });
    }

    fetchPrice();
    setInterval(fetchPrice, 60000); // refresh every minute
  </script>
</body>
</html>
